<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#8B7355">
  <title>Commonplace ‚Äî Notes & Recommendations</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ú¶</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { font-size: 16px; }
    body { font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
    ::placeholder { color: #A89B8C; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes modalFade { from { opacity: 0; transform: translateY(-8px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .card { transition: all 0.25s ease; }
    @media (hover: hover) {
      .card:hover { transform: translateY(-3px); box-shadow: 0 12px 40px rgba(139,115,85,0.15); }
      .category-tab:hover { background: rgba(139,115,85,0.08); }
      .btn-primary:hover { background: #7A6548; transform: translateY(-1px); }
      .btn-secondary:hover { background: rgba(139,115,85,0.1); }
      .star-btn:hover, .share-btn:hover { transform: scale(1.15); }
      .share-option:hover { background: rgba(139,115,85,0.1); }
      .edit-btn:hover { background: rgba(139,115,85,0.15) !important; }
      .delete-btn:hover { background: rgba(205,92,92,0.15) !important; }
      .settings-btn:hover { background: rgba(139,115,85,0.1); }
      .photo-btn:hover { background: rgba(139,115,85,0.15) !important; }
    }
    .category-tab.active { background: #8B7355 !important; color: #FDF8F3 !important; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #8B7355 !important; }
    .btn-primary:active, .btn-secondary:active, .category-tab:active { transform: scale(0.97); }
    .star-btn:active, .share-btn:active { transform: scale(0.9); }
    nav::-webkit-scrollbar { display: none; }
    .sync-indicator { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 4px 10px; border-radius: 12px; background: rgba(139,115,85,0.1); }
    .sync-indicator.synced { color: #6B8E6B; }
    .sync-indicator.syncing { color: #B8860B; }
    .sync-indicator.offline { color: #A89B8C; }
    .sync-indicator.error { color: #CD5C5C; }
    .spinner { width: 12px; height: 12px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.8s linear infinite; }
    .card-image { width: 100%; border-radius: 6px; margin-bottom: 12px; max-height: 250px; object-fit: cover; cursor: pointer; }
    .photo-upload-area { border: 2px dashed rgba(139,115,85,0.3); border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; margin-bottom: 12px; transition: all 0.2s; }
    .photo-upload-area:hover { border-color: #8B7355; background: rgba(139,115,85,0.04); }
    .photo-upload-area.has-image { border-style: solid; border-color: rgba(139,115,85,0.2); padding: 8px; }
    .photo-preview { width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px; }
    .photo-actions { display: flex; gap: 8px; margin-top: 8px; justify-content: center; }
    .uploading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,251,247,0.8); display: flex; align-items: center; justify-content: center; border-radius: 6px; flex-direction: column; gap: 8px; }
    .lightbox { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .lightbox img { max-width: 95vw; max-height: 95vh; object-fit: contain; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const supabaseAPI = {
      getConfig() { return JSON.parse(localStorage.getItem('commonplace_supabase_config') || 'null'); },
      headers(apiKey) { return { 'apikey': apiKey, 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' }; },
      async fetchEntries() {
        const c = this.getConfig(); if (!c) return null;
        const res = await fetch(`${c.url}/rest/v1/entries?select=*&order=created_at.desc`, { headers: this.headers(c.key) });
        if (!res.ok) throw new Error(`Fetch failed: ${res.status}`); return await res.json();
      },
      async upsertEntry(entry) {
        const c = this.getConfig(); if (!c) return null;
        const res = await fetch(`${c.url}/rest/v1/entries`, {
          method: 'POST', headers: { ...this.headers(c.key), 'Prefer': 'resolution=merge-duplicates,return=representation' },
          body: JSON.stringify({ id: entry.id, category: entry.category, title: entry.title, content: entry.content, date: entry.date, starred: entry.starred, image_url: entry.image_url || null, updated_at: new Date().toISOString() })
        });
        if (!res.ok) throw new Error(`Upsert failed: ${res.status}`); return await res.json();
      },
      async deleteEntry(id) {
        const c = this.getConfig(); if (!c) return null;
        const res = await fetch(`${c.url}/rest/v1/entries?id=eq.${encodeURIComponent(id)}`, { method: 'DELETE', headers: this.headers(c.key) });
        if (!res.ok) throw new Error(`Delete failed: ${res.status}`); return true;
      },
      async uploadImage(file) {
        const c = this.getConfig(); if (!c) throw new Error('Not configured');
        const ext = file.name.split('.').pop() || 'jpg';
        const filename = `${Date.now()}-${Math.random().toString(36).slice(2,8)}.${ext}`;
        const res = await fetch(`${c.url}/storage/v1/object/images/${filename}`, {
          method: 'POST',
          headers: { 'apikey': c.key, 'Authorization': `Bearer ${c.key}`, 'Content-Type': file.type, 'x-upsert': 'true' },
          body: file
        });
        if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
        return `${c.url}/storage/v1/object/public/images/${filename}`;
      },
      async testConnection() {
        const c = this.getConfig(); if (!c) return false;
        try { const res = await fetch(`${c.url}/rest/v1/entries?select=id&limit=1`, { headers: this.headers(c.key) }); return res.ok; } catch(e) { return false; }
      }
    };

    const compressImage = (file, maxWidth = 1200, quality = 0.8) => {
      return new Promise((resolve) => {
        if (file.size < 500000) { resolve(file); return; }
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, { type: 'image/jpeg' }));
            }, 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    };

    const categories = [
      { id: 'notes', label: 'Notes', icon: '‚úé', color: '#8B7355' },
      { id: 'books', label: 'Books', icon: '‚óé', color: '#6B8E6B' },
      { id: 'movies', label: 'Movies', icon: '‚ñ∂', color: '#B8860B' },
      { id: 'restaurants', label: 'Restaurants', icon: '‚óà', color: '#CD5C5C' },
      { id: 'misc', label: 'Misc', icon: '‚ú¶', color: '#708090' },
    ];

    const defaultItems = [
      { id: 'welcome-1', category: 'notes', title: 'Welcome to Commonplace', content: 'Your personal space for thoughts and discoveries. Now with photo support! üì∏', date: new Date().toISOString().split('T')[0], starred: true, image_url: null },
    ];

    const STORAGE_KEY = 'commonplace_items';
    const loadLocal = () => { try { const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : defaultItems; } catch(e) { return defaultItems; } };
    const saveLocal = (items) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); } catch(e) {} };

    function NotesApp() {
      const [items, setItems] = useState(loadLocal);
      const [activeCategory, setActiveCategory] = useState('all');
      const [isAdding, setIsAdding] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [newItem, setNewItem] = useState({ category: 'notes', title: '', content: '' });
      const [searchQuery, setSearchQuery] = useState('');
      const [shareModalId, setShareModalId] = useState(null);
      const [copyFeedback, setCopyFeedback] = useState(null);
      const [isMobile, setIsMobile] = useState(window.innerWidth < 600);
      const [showSettings, setShowSettings] = useState(false);
      const [supabaseUrl, setSupabaseUrl] = useState('');
      const [supabaseKey, setSupabaseKey] = useState('');
      const [syncStatus, setSyncStatus] = useState('offline');
      const [isConfigured, setIsConfigured] = useState(false);
      const [connectError, setConnectError] = useState('');
      const [imagePreview, setImagePreview] = useState(null);
      const [imageFile, setImageFile] = useState(null);
      const [uploading, setUploading] = useState(false);
      const [lightboxUrl, setLightboxUrl] = useState(null);
      const fileInputRef = useRef(null);

      useEffect(() => {
        const config = JSON.parse(localStorage.getItem('commonplace_supabase_config') || 'null');
        if (config?.url && config?.key) { setSupabaseUrl(config.url); setSupabaseKey(config.key); setIsConfigured(true); }
      }, []);
      useEffect(() => { if (isConfigured) fetchFromCloud(); }, [isConfigured]);

      const fetchFromCloud = async () => {
        setSyncStatus('syncing');
        try {
          const data = await supabaseAPI.fetchEntries();
          if (data && data.length > 0) {
            const formatted = data.map(item => ({ id: item.id, category: item.category, title: item.title, content: item.content, date: item.date, starred: item.starred, image_url: item.image_url || null }));
            setItems(formatted); saveLocal(formatted);
          }
          setSyncStatus('synced');
        } catch (e) { console.error('Fetch error:', e); setSyncStatus('error'); }
      };

      const handleImageSelect = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const compressed = await compressImage(file);
        setImageFile(compressed);
        const reader = new FileReader();
        reader.onload = (ev) => setImagePreview(ev.target.result);
        reader.readAsDataURL(compressed);
      };

      const removeImage = () => { setImageFile(null); setImagePreview(null); if (fileInputRef.current) fileInputRef.current.value = ''; };

      const handleAdd = async () => {
        if (!newItem.title.trim()) return;
        let imageUrl = null;
        if (imageFile && isConfigured) {
          setUploading(true);
          try { imageUrl = await supabaseAPI.uploadImage(imageFile); } catch(e) { console.error('Upload error:', e); }
          setUploading(false);
        }
        const item = { id: `item-${Date.now()}`, ...newItem, date: new Date().toISOString().split('T')[0], starred: false, image_url: imageUrl };
        const newItems = [item, ...items];
        setItems(newItems); saveLocal(newItems);
        setNewItem({ category: 'notes', title: '', content: '' }); setIsAdding(false); removeImage();
        if (isConfigured) {
          setSyncStatus('syncing');
          try { await supabaseAPI.upsertEntry(item); setSyncStatus('synced'); } catch(e) { setSyncStatus('error'); }
        }
      };

      const handleDelete = async (id) => {
        if (!window.confirm('Delete this entry?')) return;
        const newItems = items.filter(i => i.id !== id);
        setItems(newItems); saveLocal(newItems);
        if (isConfigured) {
          setSyncStatus('syncing');
          try { await supabaseAPI.deleteEntry(id); setSyncStatus('synced'); } catch(e) { setSyncStatus('error'); }
        }
      };

      const toggleStar = async (id) => {
        const updated = items.map(i => i.id === id ? { ...i, starred: !i.starred } : i);
        setItems(updated); saveLocal(updated);
        const item = updated.find(i => i.id === id);
        if (isConfigured && item) {
          setSyncStatus('syncing');
          try { await supabaseAPI.upsertEntry(item); setSyncStatus('synced'); } catch(e) { setSyncStatus('error'); }
        }
      };

      const handleEdit = (item) => {
        setEditingId(item.id);
        setNewItem({ category: item.category, title: item.title, content: item.content });
        if (item.image_url) { setImagePreview(item.image_url); } else { removeImage(); }
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const handleSaveEdit = async () => {
        let imageUrl = items.find(i => i.id === editingId)?.image_url || null;
        if (imageFile && isConfigured) {
          setUploading(true);
          try { imageUrl = await supabaseAPI.uploadImage(imageFile); } catch(e) { console.error('Upload error:', e); }
          setUploading(false);
        } else if (!imagePreview) { imageUrl = null; }
        const updated = items.map(i => i.id === editingId ? { ...i, ...newItem, image_url: imageUrl } : i);
        setItems(updated); saveLocal(updated);
        const item = updated.find(i => i.id === editingId);
        setEditingId(null); setNewItem({ category: 'notes', title: '', content: '' }); removeImage();
        if (isConfigured && item) {
          setSyncStatus('syncing');
          try { await supabaseAPI.upsertEntry(item); setSyncStatus('synced'); } catch(e) { setSyncStatus('error'); }
        }
      };

      const saveSupabaseConfig = async () => {
        if (!supabaseUrl || !supabaseKey) return;
        setConnectError('');
        localStorage.setItem('commonplace_supabase_config', JSON.stringify({ url: supabaseUrl.replace(/\/$/, ''), key: supabaseKey.trim() }));
        const ok = await supabaseAPI.testConnection();
        if (ok) { setIsConfigured(true); setShowSettings(false); } else { localStorage.removeItem('commonplace_supabase_config'); setConnectError('Connection failed. Check your URL and key.'); }
      };

      const disconnectSupabase = () => {
        localStorage.removeItem('commonplace_supabase_config');
        setSupabaseUrl(''); setSupabaseKey(''); setIsConfigured(false); setSyncStatus('offline'); setShowSettings(false); setConnectError('');
      };

      useEffect(() => { const h = () => setIsMobile(window.innerWidth < 600); window.addEventListener('resize', h); return () => window.removeEventListener('resize', h); }, []);

      const filteredItems = items.filter(item => {
        const mc = activeCategory === 'all' || item.category === activeCategory;
        const ms = item.title.toLowerCase().includes(searchQuery.toLowerCase()) || item.content.toLowerCase().includes(searchQuery.toLowerCase());
        return mc && ms;
      });

      const getCategoryInfo = (cid) => categories.find(c => c.id === cid);
      const formatShareText = (item) => { const ci = getCategoryInfo(item.category); return `${ci.icon} ${ci.label.toUpperCase()}\n\n${item.title}\n\n${item.content}\n\n‚Äî Shared from Commonplace`; };
      const handleCopyText = async (item) => {
        const text = formatShareText(item);
        try { await navigator.clipboard.writeText(text); } catch(e) { const t = document.createElement('textarea'); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); }
        setCopyFeedback(item.id); setTimeout(() => setCopyFeedback(null), 2000);
      };
      const handleNativeShare = async (item) => { const ci = getCategoryInfo(item.category); if (navigator.share) { try { await navigator.share({ title: item.title, text: `${ci.icon} ${item.title}\n\n${item.content}` }); setShareModalId(null); } catch(e) {} } };
      const handleShareEmail = (item) => { const ci = getCategoryInfo(item.category); window.location.href = `mailto:?subject=${encodeURIComponent(ci.icon+' '+item.title)}&body=${encodeURIComponent(formatShareText(item))}`; setShareModalId(null); };
      const handleShareTwitter = (item) => { window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(item.title+'\n\n"'+item.content.slice(0,180)+(item.content.length>180?'...':'')+'"')}`, '_blank'); setShareModalId(null); };

      const st = {
        container: { minHeight: '100vh', background: 'linear-gradient(180deg, #FDF8F3 0%, #F5EDE4 100%)', fontFamily: '"Source Sans 3", -apple-system, sans-serif', color: '#3D3428', paddingBottom: 'env(safe-area-inset-bottom)' },
        header: { background: 'linear-gradient(180deg, #FFFBF7 0%, #FDF8F3 100%)', borderBottom: '1px solid rgba(139,115,85,0.15)', padding: isMobile ? '16px' : '24px 32px', position: 'sticky', top: 0, zIndex: 50 },
        headerContent: { maxWidth: 1200, margin: '0 auto' },
        headerTop: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: isMobile ? 12 : 16 },
        logoSection: { display: 'flex', alignItems: 'center', gap: 12 },
        logoMark: { width: isMobile ? 40 : 48, height: isMobile ? 40 : 48, background: 'linear-gradient(135deg, #8B7355, #6B5344)', borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#FDF8F3', fontSize: isMobile ? 16 : 20, flexShrink: 0 },
        title: { fontFamily: '"Playfair Display", serif', fontSize: isMobile ? 22 : 28, fontWeight: 600, margin: 0, color: '#2D2416' },
        subtitle: { margin: 0, fontSize: isMobile ? 12 : 14, color: '#8B7355', fontStyle: 'italic' },
        headerRight: { display: 'flex', alignItems: 'center', gap: 8 },
        settingsBtn: { background: 'none', border: 'none', fontSize: 22, cursor: 'pointer', padding: 8, borderRadius: 8, color: '#8B7355', lineHeight: 1 },
        searchInput: { width: '100%', padding: '12px 16px', border: '1px solid rgba(139,115,85,0.2)', borderRadius: 8, fontSize: 16, background: '#FFFBF7', fontFamily: '"Source Sans 3", sans-serif' },
        nav: { maxWidth: 1200, margin: '0 auto', padding: isMobile ? '12px 16px' : '16px 32px', display: 'flex', gap: 6, overflowX: 'auto', WebkitOverflowScrolling: 'touch', scrollbarWidth: 'none' },
        categoryTab: { padding: isMobile ? '8px 14px' : '10px 18px', border: 'none', borderRadius: 20, background: 'transparent', cursor: 'pointer', fontSize: isMobile ? 13 : 14, fontWeight: 500, color: '#5D5145', fontFamily: '"Source Sans 3", sans-serif', whiteSpace: 'nowrap', flexShrink: 0 },
        main: { maxWidth: 1200, margin: '0 auto', padding: isMobile ? '0 16px 32px' : '0 32px 48px' },
        addButton: { display: 'inline-flex', alignItems: 'center', justifyContent: 'center', gap: 8, padding: isMobile ? '14px 20px' : '14px 24px', background: '#8B7355', color: '#FDF8F3', border: 'none', borderRadius: 8, fontSize: 15, fontWeight: 500, cursor: 'pointer', marginBottom: 20, fontFamily: '"Source Sans 3", sans-serif', width: isMobile ? '100%' : 'auto' },
        formCard: { background: '#FFFBF7', borderRadius: 12, padding: isMobile ? 20 : 28, marginBottom: 24, boxShadow: '0 4px 24px rgba(139,115,85,0.1)', animation: 'slideDown 0.3s ease', position: 'relative' },
        formTitle: { fontFamily: '"Playfair Display", serif', fontSize: isMobile ? 18 : 20, fontWeight: 600, margin: '0 0 16px', color: '#2D2416' },
        select: { width: '100%', padding: '12px 14px', border: '1px solid rgba(139,115,85,0.2)', borderRadius: 8, fontSize: 16, marginBottom: 12, background: '#FDF8F3', fontFamily: '"Source Sans 3", sans-serif' },
        input: { width: '100%', padding: '12px 14px', border: '1px solid rgba(139,115,85,0.2)', borderRadius: 8, fontSize: 16, marginBottom: 12, background: '#FDF8F3', fontFamily: '"Source Sans 3", sans-serif' },
        textarea: { width: '100%', padding: '12px 14px', border: '1px solid rgba(139,115,85,0.2)', borderRadius: 8, fontSize: 16, marginBottom: 12, background: '#FDF8F3', fontFamily: '"Source Sans 3", sans-serif', resize: 'vertical', minHeight: 100, lineHeight: 1.6 },
        formActions: { display: 'flex', gap: 12, justifyContent: 'flex-end', flexDirection: isMobile ? 'column-reverse' : 'row' },
        cancelButton: { padding: '12px 20px', border: '1px solid rgba(139,115,85,0.3)', borderRadius: 6, background: 'transparent', cursor: 'pointer', fontSize: 14, fontWeight: 500, color: '#5D5145', fontFamily: '"Source Sans 3", sans-serif', width: isMobile ? '100%' : 'auto' },
        saveButton: { padding: '12px 24px', border: 'none', borderRadius: 6, background: '#8B7355', color: '#FDF8F3', cursor: 'pointer', fontSize: 14, fontWeight: 500, fontFamily: '"Source Sans 3", sans-serif', width: isMobile ? '100%' : 'auto' },
        grid: { display: 'grid', gridTemplateColumns: isMobile ? '1fr' : 'repeat(auto-fill, minmax(300px, 1fr))', gap: isMobile ? 16 : 20 },
        card: { background: '#FFFBF7', borderRadius: 10, padding: isMobile ? 18 : 22, boxShadow: '0 2px 16px rgba(139,115,85,0.08)', animation: 'fadeIn 0.4s ease forwards', opacity: 0 },
        cardHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 },
        cardHeaderActions: { display: 'flex', alignItems: 'center', gap: 2 },
        shareContainer: { position: 'relative' },
        shareButton: { background: 'none', border: 'none', fontSize: 18, cursor: 'pointer', padding: '6px 8px', borderRadius: 4, color: '#8B7355' },
        shareModal: { position: 'absolute', top: '100%', right: 0, marginTop: 8, background: '#FFFBF7', borderRadius: 10, boxShadow: '0 8px 32px rgba(45,36,22,0.2)', border: '1px solid rgba(139,115,85,0.15)', minWidth: isMobile ? 180 : 200, zIndex: 100, animation: 'modalFade 0.2s ease', overflow: 'hidden' },
        shareModalHeader: { padding: '12px 16px', fontSize: 11, fontWeight: 600, color: '#8B7355', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: '1px solid rgba(139,115,85,0.1)' },
        shareOption: { display: 'flex', alignItems: 'center', gap: 10, width: '100%', padding: '14px 16px', border: 'none', background: 'none', cursor: 'pointer', fontSize: 14, color: '#3D3428', textAlign: 'left', fontFamily: '"Source Sans 3", sans-serif' },
        shareIcon: { fontSize: 16, width: 20, textAlign: 'center' },
        categoryBadge: { fontSize: 11, fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' },
        starButton: { background: 'none', border: 'none', fontSize: 22, cursor: 'pointer', padding: '4px 6px' },
        cardTitle: { fontFamily: '"Playfair Display", serif', fontSize: isMobile ? 17 : 19, fontWeight: 600, margin: '0 0 8px', color: '#2D2416', lineHeight: 1.3 },
        cardContent: { fontSize: 14, lineHeight: 1.65, color: '#5D5145', margin: '0 0 14px' },
        cardFooter: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: 12, borderTop: '1px solid rgba(139,115,85,0.1)', flexWrap: 'wrap', gap: 8 },
        date: { fontSize: 12, color: '#A89B8C', fontStyle: 'italic' },
        cardActions: { display: 'flex', gap: 8 },
        editButton: { padding: '8px 14px', border: 'none', borderRadius: 4, background: 'rgba(139,115,85,0.08)', cursor: 'pointer', fontSize: 12, fontWeight: 500, color: '#6B5A48', fontFamily: '"Source Sans 3", sans-serif' },
        deleteButton: { padding: '8px 14px', border: 'none', borderRadius: 4, background: 'rgba(205,92,92,0.08)', cursor: 'pointer', fontSize: 12, fontWeight: 500, color: '#B85450', fontFamily: '"Source Sans 3", sans-serif' },
        footer: { textAlign: 'center', padding: '20px', color: '#A89B8C', fontSize: 12, borderTop: '1px solid rgba(139,115,85,0.1)', letterSpacing: '1px' },
        modalOverlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(45,36,22,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: 20 },
        modalContent: { background: '#FFFBF7', borderRadius: 16, padding: isMobile ? 24 : 32, maxWidth: 480, width: '100%', maxHeight: '90vh', overflow: 'auto', animation: 'modalFade 0.2s ease' },
        modalTitle: { fontFamily: '"Playfair Display", serif', fontSize: 22, fontWeight: 600, margin: '0 0 8px', color: '#2D2416' },
        modalSubtitle: { fontSize: 14, color: '#8B7355', margin: '0 0 24px', lineHeight: 1.5 },
        inputLabel: { display: 'block', fontSize: 13, fontWeight: 600, color: '#5D5145', marginBottom: 6 },
        helpText: { fontSize: 12, color: '#A89B8C', margin: '4px 0 16px' },
        dangerButton: { padding: '10px 16px', border: 'none', borderRadius: 6, background: 'rgba(205,92,92,0.1)', color: '#B85450', cursor: 'pointer', fontSize: 14, fontWeight: 500, fontFamily: '"Source Sans 3", sans-serif' },
        statusBadge: { display: 'inline-flex', alignItems: 'center', gap: 6, padding: '6px 12px', borderRadius: 16, fontSize: 13, fontWeight: 500 },
        errorText: { color: '#CD5C5C', fontSize: 13, margin: '8px 0 16px', padding: '8px 12px', background: 'rgba(205,92,92,0.08)', borderRadius: 6 },
      };

      const syncDisp = syncStatus === 'synced' ? { text: '‚úì Synced', cls: 'synced' } : syncStatus === 'syncing' ? { text: 'Syncing', cls: 'syncing', spin: true } : syncStatus === 'error' ? { text: '‚ö† Error', cls: 'error' } : { text: 'Local only', cls: 'offline' };

      return (
        <div style={st.container} onClick={() => shareModalId && setShareModalId(null)}>
          {lightboxUrl && <div className="lightbox" onClick={() => setLightboxUrl(null)}><img src={lightboxUrl} alt="Full size" /></div>}

          {showSettings && (
            <div style={st.modalOverlay} onClick={() => setShowSettings(false)}>
              <div style={st.modalContent} onClick={e => e.stopPropagation()}>
                <h2 style={st.modalTitle}>‚öôÔ∏è Settings</h2>
                <p style={st.modalSubtitle}>Connect to Supabase to sync your notes and photos across all devices.</p>
                {isConfigured ? (
                  <div>
                    <div style={{ ...st.statusBadge, background: syncStatus === 'synced' ? 'rgba(107,142,107,0.15)' : syncStatus === 'error' ? 'rgba(205,92,92,0.15)' : 'rgba(184,134,11,0.15)', color: syncStatus === 'synced' ? '#6B8E6B' : syncStatus === 'error' ? '#CD5C5C' : '#B8860B', marginBottom: 20 }}>
                      {syncStatus === 'synced' ? '‚úì Connected & Synced' : syncStatus === 'error' ? '‚ö† Connection Error' : '‚Üª Syncing...'}
                    </div>
                    <p style={{ fontSize: 14, color: '#5D5145', marginBottom: 20 }}>Your notes and photos are syncing to Supabase.</p>
                    <button onClick={fetchFromCloud} className="btn-secondary" style={{ ...st.cancelButton, marginRight: 12, marginBottom: 12 }}>‚Üª Refresh</button>
                    <button onClick={disconnectSupabase} style={st.dangerButton}>Disconnect</button>
                  </div>
                ) : (
                  <div>
                    <label style={st.inputLabel}>Supabase Project URL</label>
                    <input type="text" placeholder="https://xxxxx.supabase.co" value={supabaseUrl} onChange={e => setSupabaseUrl(e.target.value)} style={st.input} />
                    <p style={st.helpText}>Found in Project Settings ‚Üí Data API</p>
                    <label style={st.inputLabel}>Supabase API Key</label>
                    <input type="text" placeholder="eyJ... or sb_publishable_..." value={supabaseKey} onChange={e => setSupabaseKey(e.target.value)} style={st.input} />
                    <p style={st.helpText}>Use Legacy anon key (eyJ...) from Settings ‚Üí API Keys</p>
                    {connectError && <div style={st.errorText}>‚ö† {connectError}</div>}
                    <div style={{ ...st.formActions, marginTop: 24 }}>
                      <button onClick={() => { setShowSettings(false); setConnectError(''); }} className="btn-secondary" style={st.cancelButton}>Cancel</button>
                      <button onClick={saveSupabaseConfig} className="btn-primary" style={st.saveButton}>Connect</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          <header style={st.header}>
            <div style={st.headerContent}>
              <div style={st.headerTop}>
                <div style={st.logoSection}>
                  <div style={st.logoMark}>‚ú¶</div>
                  <div>
                    <h1 style={st.title}>Commonplace</h1>
                    <p style={st.subtitle}>Thoughts & discoveries</p>
                  </div>
                </div>
                <div style={st.headerRight}>
                  <div className={`sync-indicator ${syncDisp.cls}`}>
                    {syncDisp.spin && <div className="spinner" />}
                    {syncDisp.text}
                  </div>
                  <button className="settings-btn" onClick={() => setShowSettings(true)} style={st.settingsBtn} title="Settings">‚öôÔ∏è</button>
                </div>
              </div>
              <input type="text" placeholder="Search..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} style={st.searchInput} />
            </div>
          </header>

          <nav style={st.nav}>
            <button className={`category-tab ${activeCategory === 'all' ? 'active' : ''}`} onClick={() => setActiveCategory('all')} style={st.categoryTab}>All</button>
            {categories.map(cat => (
              <button key={cat.id} className={`category-tab ${activeCategory === cat.id ? 'active' : ''}`} onClick={() => setActiveCategory(cat.id)} style={st.categoryTab}>
                <span style={{ marginRight: 5 }}>{cat.icon}</span>{cat.label}
              </button>
            ))}
          </nav>

          <main style={st.main}>
            {!isAdding && !editingId && <button className="btn-primary" onClick={() => setIsAdding(true)} style={st.addButton}>+ Add New Entry</button>}

            {(isAdding || editingId) && (
              <div style={st.formCard}>
                {uploading && <div className="uploading-overlay"><div className="spinner" style={{ width: 24, height: 24, borderWidth: 3, color: '#8B7355' }} /><span style={{ fontSize: 14, color: '#8B7355' }}>Uploading photo...</span></div>}
                <h3 style={st.formTitle}>{editingId ? 'Edit Entry' : 'New Entry'}</h3>
                <select value={newItem.category} onChange={e => setNewItem({ ...newItem, category: e.target.value })} style={st.select}>
                  {categories.map(cat => <option key={cat.id} value={cat.id}>{cat.icon} {cat.label}</option>)}
                </select>
                <input type="text" placeholder="Title" value={newItem.title} onChange={e => setNewItem({ ...newItem, title: e.target.value })} style={st.input} />
                <textarea placeholder="Your thoughts, notes, or recommendations..." value={newItem.content} onChange={e => setNewItem({ ...newItem, content: e.target.value })} style={st.textarea} />
                
                <input type="file" accept="image/*" capture="environment" ref={fileInputRef} onChange={handleImageSelect} style={{ display: 'none' }} />
                
                {imagePreview ? (
                  <div className="photo-upload-area has-image">
                    <img src={imagePreview} className="photo-preview" alt="Preview" />
                    <div className="photo-actions">
                      <button onClick={() => fileInputRef.current?.click()} className="photo-btn" style={{ ...st.editButton, padding: '6px 12px' }}>üì∑ Change</button>
                      <button onClick={removeImage} className="photo-btn" style={{ ...st.deleteButton, padding: '6px 12px' }}>‚úï Remove</button>
                    </div>
                  </div>
                ) : (
                  <div className="photo-upload-area" onClick={() => fileInputRef.current?.click()}>
                    <div style={{ fontSize: 28, marginBottom: 6 }}>üì∑</div>
                    <div style={{ fontSize: 14, color: '#8B7355', fontWeight: 500 }}>Add a photo</div>
                    <div style={{ fontSize: 12, color: '#A89B8C', marginTop: 2 }}>
                      {isMobile ? 'Tap to take a photo or choose from library' : 'Click to choose a photo'}
                    </div>
                    {!isConfigured && <div style={{ fontSize: 11, color: '#CD5C5C', marginTop: 6 }}>Connect Supabase in settings to enable photo uploads</div>}
                  </div>
                )}

                <div style={st.formActions}>
                  <button className="btn-secondary" onClick={() => { setIsAdding(false); setEditingId(null); setNewItem({ category: 'notes', title: '', content: '' }); removeImage(); }} style={st.cancelButton}>Cancel</button>
                  <button className="btn-primary" onClick={editingId ? handleSaveEdit : handleAdd} style={st.saveButton} disabled={uploading}>{editingId ? 'Save Changes' : 'Add Entry'}</button>
                </div>
              </div>
            )}

            <div style={st.grid}>
              {filteredItems.map((item, i) => {
                const ci = getCategoryInfo(item.category);
                return (
                  <article key={item.id} className="card" style={{ ...st.card, animationDelay: `${i*0.05}s`, borderLeft: `3px solid ${ci.color}` }}>
                    <div style={st.cardHeader}>
                      <span style={{ ...st.categoryBadge, color: ci.color }}>{ci.icon} {ci.label}</span>
                      <div style={st.cardHeaderActions}>
                        <button className="star-btn" onClick={() => toggleStar(item.id)} style={{ ...st.starButton, color: item.starred ? '#B8860B' : '#D4C4B0' }}>{item.starred ? '‚òÖ' : '‚òÜ'}</button>
                        <div style={st.shareContainer} onClick={e => e.stopPropagation()}>
                          <button className="share-btn" onClick={() => setShareModalId(shareModalId === item.id ? null : item.id)} style={st.shareButton}>‚Üó</button>
                          {shareModalId === item.id && (
                            <div style={st.shareModal}>
                              <div style={st.shareModalHeader}>Share</div>
                              <button onClick={() => handleCopyText(item)} style={st.shareOption} className="share-option"><span style={st.shareIcon}>üìã</span>{copyFeedback === item.id ? 'Copied!' : 'Copy text'}</button>
                              {navigator.share && <button onClick={() => handleNativeShare(item)} style={st.shareOption} className="share-option"><span style={st.shareIcon}>üì§</span>Share...</button>}
                              <button onClick={() => handleShareEmail(item)} style={st.shareOption} className="share-option"><span style={st.shareIcon}>‚úâÔ∏è</span>Email</button>
                              <button onClick={() => handleShareTwitter(item)} style={st.shareOption} className="share-option"><span style={st.shareIcon}>ùïè</span>Post on X</button>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                    {item.image_url && <img src={item.image_url} className="card-image" alt="" onClick={() => setLightboxUrl(item.image_url)} />}
                    <h3 style={st.cardTitle}>{item.title}</h3>
                    <p style={st.cardContent}>{item.content}</p>
                    <div style={st.cardFooter}>
                      <span style={st.date}>{item.date}</span>
                      <div style={st.cardActions}>
                        <button className="edit-btn" onClick={() => handleEdit(item)} style={st.editButton}>Edit</button>
                        <button className="delete-btn" onClick={() => handleDelete(item.id)} style={st.deleteButton}>Delete</button>
                      </div>
                    </div>
                  </article>
                );
              })}
            </div>

            {filteredItems.length === 0 && (
              <div style={{ textAlign: 'center', padding: '48px 20px' }}>
                <div style={{ fontSize: 40, color: '#D4C4B0', marginBottom: 12 }}>‚óá</div>
                <p style={{ fontSize: 16, color: '#6B5A48', margin: '0 0 6px', fontFamily: '"Playfair Display", serif' }}>{searchQuery ? 'No matches found' : 'No entries yet'}</p>
                <p style={{ fontSize: 13, color: '#A89B8C', margin: 0 }}>{searchQuery ? 'Try different keywords' : 'Tap the button above to add one'}</p>
              </div>
            )}
          </main>

          <footer style={st.footer}><p>‚ú¶ {items.length} entries ‚ú¶</p></footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<NotesApp />);
  </script>
</body>
</html>
